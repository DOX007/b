<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>VordNotes – Org Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
    h1 { margin-bottom: 8px; }
    section { border: 1px solid #2a2a2a; border-radius: 12px; padding: 16px; margin: 16px 0; }
    label { display:block; font-size: 12px; opacity:.9; margin: 8px 0 4px; }
    input, select, button { font: inherit; padding: 8px 10px; border-radius: 8px; }
    input, select { width: 100%; box-sizing: border-box; border: 1px solid #3a3a3a; background: transparent; color: inherit; }
    button { cursor: pointer; background: #111827; color: white; border: none; }
    button.secondary { background: #6b7280; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; align-items: end; }
    .row > * { min-width: 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { opacity: .75; font-size: 12px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#374151; font-size: 12px; }
    ul { padding-left: 18px; }
    li { margin: 10px 0; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>VordNotes – Org Admin</h1>

  <!-- LOGIN -------------------------------------------------------------->
  <section>
    <h2>Logga in (admin)</h2>
    <div class="row">
      <div>
        <label>Admin e-post</label>
        <input id="email" class="mono" placeholder="admin@example.com" />
      </div>
      <div>
        <label>Lösenord</label>
        <input id="password" type="password" />
      </div>
      <button id="loginBtn">Logga in</button>
      <button id="logoutBtn" class="secondary">Logga ut</button>
    </div>
    <p id="loginMsg" class="muted"> </p>
  </section>

  <!-- CREATE USER -------------------------------------------------------->
  <section>
    <h2>Skapa konto</h2>
    <div class="row">
      <div>
        <label>E-post</label>
        <input id="newEmail" class="mono" placeholder="user@example.com" />
      </div>
      <div>
        <label>Temporärt lösenord</label>
        <input id="newPassword" type="password" value="TempPass123!" />
      </div>
      <div>
        <label>Organisation (orgId)</label>
        <input id="orgId" class="mono" placeholder="vordnotes-dev" />
      </div>
      <div>
        <label>Roll</label>
        <select id="role">
          <option value="staff">staff</option>
          <option value="admin">admin</option>
        </select>
      </div>
      <button id="createBtn">Skapa användare</button>
    </div>
    <p id="createMsg" class="muted"> </p>
  </section>

  <!-- LIST USERS --------------------------------------------------------->
  <section>
    <h2>Lista användare</h2>
    <button id="listBtn" class="secondary">Ladda lista</button>
    <p id="listMsg" class="muted"> </p>
    <ul id="users"></ul>
  </section>

  <!-- Firebase SDK -->
  <script type="module">
    // === Firebase (byt till ditt projekt)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    // Prod-konfig (som i din senaste fil)
    const firebaseConfig = {
      apiKey: "AIzaSyD837dSDubNSKKRxZuxaOym25vF87eTfqI",
      authDomain: "vordnotes.firebaseapp.com",
      projectId: "vordnotes",
      storageBucket: "vordnotes.appspot.com",
      messagingSenderId: "336975924503",
      appId: "1:336975924503:web:e283bcb380ce1e56dc3b52",
      measurementId: "G-DNGLKMVW95"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    // Callables
    const cfCreateUserWithClaims = httpsCallable(functions, "createUserWithClaims");
    const cfListUsers            = httpsCallable(functions, "listUsers");
    const cfDeleteUserByUid      = httpsCallable(functions, "deleteUserByUid");

    // Helpers
    const $ = (id) => document.getElementById(id);
    const setMsg = (el, msg, kind="") => {
      el.textContent = msg;
      el.style.color = kind === "err" ? "#ef4444" : kind === "ok" ? "#10b981" : "inherit";
    };
    const asErr = (e) => (e?.message || e?.toString?.() || String(e));

    // STATE
    const loginMsgEl  = $("loginMsg");
    const createMsgEl = $("createMsg");
    const listMsgEl   = $("listMsg");
    const usersEl     = $("users");

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setMsg(loginMsgEl, `Inloggning OK. Inloggad som: ${user.email}`, "ok");
      } else {
        setMsg(loginMsgEl, "Inte inloggad.", "");
      }
    });

    // LOGIN
    $("loginBtn").addEventListener("click", async () => {
      setMsg(loginMsgEl, "Loggar in…");
      try {
        const email = $("email").value.trim();
        const password = $("password").value;
        await signInWithEmailAndPassword(auth, email, password);
        setMsg(loginMsgEl, "Inloggning OK.", "ok");
      } catch (e) {
        setMsg(loginMsgEl, "Fel vid inloggning: " + asErr(e), "err");
      }
    });

    $("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      setMsg(loginMsgEl, "Utloggad.", "ok");
    });

    // CREATE
    $("createBtn").addEventListener("click", async () => {
  setMsg(createMsgEl, "Skapar…");
  try {
    const email = $("newEmail").value.trim();
    const password = $("newPassword").value;
    const orgId = $("orgId").value.trim();
    const role = $("role").value;

    await cfCreateUserWithClaims({ email, password, orgId, role });
    setMsg(createMsgEl, `Skapade ${email} (${role}) i ${orgId}.`, "ok");
    $("newEmail").value = "";
  } catch (e) {
    const msg = e?.message || "";
    if (msg.includes("claim propagation lag")) {
      setMsg(
        createMsgEl,
        `Kontot skapades, Vänta 10 sekunder innan listan uppdateras.`,
        "ok"
      );
    } else {
      setMsg(createMsgEl, "Kunde inte skapa användare: " + asErr(e), "err");
    }
  }
});


    // LIST
    $("listBtn").addEventListener("click", async () => {
      setMsg(listMsgEl, "Hämtar…");
      usersEl.innerHTML = "";
      try {
        const { data } = await cfListUsers({});
        const list = data?.users || [];

        list.forEach(u => {
          const li = document.createElement("li");
          const email = u.email || "(okänd e-post)";
          const uid = u.uid || "(okänt uid)";
          const claims = u.claims || u.customClaims || {};
          const isAdmin = (claims.role === "admin");
          const orgId = claims.orgId || "(saknas)";

          // ★ Knappen först (vänster)
          li.innerHTML = `
            <div class="bar">
              <button class="secondary delBtn" data-uid="${uid}" data-email="${email}" ${isAdmin ? "disabled" : ""}>Ta bort</button>
              <span class="mono">${email}</span>
              <span class="pill">${isAdmin ? "admin" : "staff"}</span>
              <span class="pill">org: ${orgId}</span>
            </div>
            <div class="muted mono">uid: ${uid}</div>
          `;

          // Delete handler – admin får ALDRIG tas bort (skydd i UI + extra check)
          const btn = li.querySelector(".delBtn");
          btn?.addEventListener("click", async (ev) => {
            if (isAdmin) return; // extra UI-skydd
            const b = ev.currentTarget;
            const uid = b.getAttribute("data-uid");
            const email = b.getAttribute("data-email");

            if (!uid || uid === "(okänt uid)") {
              alert("Saknar uid för användaren — kan inte ta bort.");
              return;
            }
            if (!confirm(`Ta bort kontot "${email}"?\nDetta går inte att ångra.`)) return;

            b.disabled = true;
            b.textContent = "Tar bort…";
            try {
              await cfDeleteUserByUid({ uid });
              li.remove();
              setMsg(listMsgEl, `Tog bort: ${email}`, "ok");
            } catch (e) {
              b.disabled = false;
              b.textContent = "Ta bort";
              setMsg(listMsgEl, "Kunde inte ta bort: " + asErr(e), "err");
            }
          });

          usersEl.appendChild(li);
        });

        setMsg(listMsgEl, `Klar. (${list.length} användare)`, "ok");
      } catch (e) {
        setMsg(listMsgEl, "Kunde inte hämta lista: " + asErr(e), "err");
      }
    });
  </script>
</body>
</html>
