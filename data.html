<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>VordNotes – Data Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root { color-scheme: dark light; }
body {
  font-family: system-ui, sans-serif;
  max-width: 1200px;
  margin: 24px auto;
  padding: 0 16px;
}
section {
  border: 1px solid #333;
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
}
label { font-size: 13px; opacity:.8; display:block; margin-top:8px; }
input, textarea, select, button {
  font: inherit;
  padding: 8px;
  border-radius: 8px;
  width:100%;
}
textarea { resize: vertical; font-family: ui-monospace; }
button { background:#111827; color:white; border:none; cursor:pointer; }
button.secondary { background:#6b7280; }
button.danger { background:#991b1b; }
.row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.item { border:1px solid #444; border-radius:8px; padding:14px; margin:14px 0; }
.mono { font-family: ui-monospace; font-size:13px; }
.subtask {
  border:1px dashed #555;
  padding:8px;
  margin:6px 0;
}
.bar { display:flex; gap:10px; margin-top:12px; }
</style>
</head>

<body>

<h1>VordNotes – Data Admin</h1>

<section>
<h2>Inloggning</h2>
<div class="row">
  <input id="email" placeholder="email">
  <input id="password" type="password" placeholder="lösenord">
  <button id="loginBtn">Logga in</button>
  <button id="logoutBtn" class="secondary">Logga ut</button>
</div>
<p id="authMsg"></p>
</section>

<section>
<h2>Databas</h2>
<div class="row">
  <select id="collection">
    <option value="notes">notes</option>
    <option value="tasks">tasks</option>
    <option value="bookmarks">bookmarks</option>
  </select>
  <button id="loadBtn">Ladda data</button>
</div>
</section>

<section>
<h2>Poster</h2>
<div id="list"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD837dSDubNSKKRxZuxaOym25vF87eTfqI",
  authDomain: "vordnotes.firebaseapp.com",
  projectId: "vordnotes",
  storageBucket: "vordnotes.appspot.com",
  messagingSenderId: "336975924503",
  appId: "1:336975924503:web:e283bcb380ce1e56dc3b52"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);

onAuthStateChanged(auth, u => {
  $("authMsg").textContent = u ? `Inloggad: ${u.email}` : "Inte inloggad";
});

$("loginBtn").onclick = () =>
  signInWithEmailAndPassword(auth, $("email").value, $("password").value);

$("logoutBtn").onclick = () => signOut(auth);

$("loadBtn").onclick = async () => {
  $("list").innerHTML = "";
  const col = $("collection").value;

  const snap = await getDocs(
    collection(db, "workspace", "shared", col)
  );

  snap.forEach(d => {
    const data = d.data();
    const el = document.createElement("div");
    el.className = "item";

    if (col === "tasks") {
      const subTasks = data.subTasks ?? [];

      el.innerHTML = `
        <div class="mono">ID: ${data.id}</div>

        <label>Titel</label>
        <input class="title" value="${data.title ?? ""}">

        <label>Beskrivning</label>
        <textarea class="desc">${data.description ?? ""}</textarea>

        <label>SubTasks (mediciner)</label>
        <div class="subs">
          ${subTasks.map((s, i) => `
            <div class="subtask">
              <input class="subTitle" data-i="${i}" value="${s.title ?? ""}">
              <label>
                <input type="checkbox" class="subDone" data-i="${i}" ${s.isCompleted ? "checked" : ""}>
                Klar
              </label>
            </div>
          `).join("")}
        </div>

        <button class="secondary addSub">+ Lägg till SubTask</button>

        <div class="bar">
          <button class="save">Spara</button>
          <button class="danger del">Radera</button>
        </div>
      `;

      el.querySelector(".addSub").onclick = () => {
        subTasks.push({ title:"", isCompleted:false });
        $("loadBtn").click();
      };

      el.querySelector(".save").onclick = async () => {
        const titles = el.querySelectorAll(".subTitle");
        const dones  = el.querySelectorAll(".subDone");

        const newSubs = subTasks.map((s, i) => ({
          ...s,
          title: titles[i].value,
          isCompleted: dones[i].checked
        }));

        await updateDoc(
          doc(db, "workspace", "shared", col, d.id),
          {
            title: el.querySelector(".title").value,
            description: el.querySelector(".desc").value,
            subTasks: newSubs,
            updatedDate: Date.now()
          }
        );
        alert("Sparat ✔");
      };
    }

    el.querySelector(".del")?.addEventListener("click", async () => {
      if (!confirm("Radera posten?")) return;
      await deleteDoc(doc(db, "workspace", "shared", col, d.id));
      el.remove();
    });

    $("list").appendChild(el);
  });
};
</script>
</body>
</html>
